{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://aca.local/schemas/feature-mcp-tool-contract.schema.json",
  "title": "ACA Feature MCP Tool Contract",
  "description": "Draft contract for ACA MCP tools that access Feature SaaS",
  "type": "object",
  "required": ["contractVersion", "invocation"],
  "properties": {
    "contractVersion": {
      "type": "string",
      "pattern": "^0\\.[0-9]+\\.[0-9]+-draft$"
    },
    "invocation": {
      "$ref": "#/$defs/ToolInvocation"
    },
    "result": {
      "$ref": "#/$defs/ToolResult"
    }
  },
  "additionalProperties": false,
  "$defs": {
    "ToolName": {
      "type": "string",
      "enum": [
        "feature.search",
        "feature.get",
        "feature.register",
        "feature.update_status",
        "feature.use"
      ]
    },
    "ActorContext": {
      "type": "object",
      "required": ["agentId", "organizationId", "projectId"],
      "properties": {
        "agentId": { "type": "string", "minLength": 1 },
        "organizationId": { "type": "string", "format": "uuid" },
        "projectId": { "type": "string", "format": "uuid" },
        "ticketId": { "type": "string" },
        "runId": { "type": "string" }
      },
      "additionalProperties": false
    },
    "ToolInvocation": {
      "type": "object",
      "required": ["tool", "requestId", "issuedAt", "actor", "input"],
      "properties": {
        "tool": { "$ref": "#/$defs/ToolName" },
        "requestId": { "type": "string", "minLength": 1 },
        "issuedAt": { "type": "string", "format": "date-time" },
        "idempotencyKey": { "type": "string" },
        "actor": { "$ref": "#/$defs/ActorContext" },
        "input": { "type": "object" }
      },
      "allOf": [
        {
          "if": { "properties": { "tool": { "const": "feature.search" } }, "required": ["tool"] },
          "then": { "properties": { "input": { "$ref": "#/$defs/FeatureSearchInput" } } }
        },
        {
          "if": { "properties": { "tool": { "const": "feature.get" } }, "required": ["tool"] },
          "then": { "properties": { "input": { "$ref": "#/$defs/FeatureGetInput" } } }
        },
        {
          "if": { "properties": { "tool": { "const": "feature.register" } }, "required": ["tool"] },
          "then": { "properties": { "input": { "$ref": "#/$defs/FeatureRegisterInput" } } }
        },
        {
          "if": { "properties": { "tool": { "const": "feature.update_status" } }, "required": ["tool"] },
          "then": { "properties": { "input": { "$ref": "#/$defs/FeatureUpdateStatusInput" } } }
        },
        {
          "if": { "properties": { "tool": { "const": "feature.use" } }, "required": ["tool"] },
          "then": { "properties": { "input": { "$ref": "#/$defs/FeatureUseInput" } } }
        }
      ],
      "additionalProperties": false
    },
    "ToolResult": {
      "type": "object",
      "required": ["requestId", "status", "completedAt"],
      "properties": {
        "requestId": { "type": "string" },
        "status": { "type": "string", "enum": ["ok", "error"] },
        "completedAt": { "type": "string", "format": "date-time" },
        "output": { "type": "object" },
        "error": { "$ref": "#/$defs/ErrorPayload" }
      },
      "allOf": [
        {
          "if": { "properties": { "status": { "const": "ok" } }, "required": ["status"] },
          "then": { "required": ["output"] }
        },
        {
          "if": { "properties": { "status": { "const": "error" } }, "required": ["status"] },
          "then": { "required": ["error"] }
        }
      ],
      "additionalProperties": false
    },
    "ErrorPayload": {
      "type": "object",
      "required": ["code", "message"],
      "properties": {
        "code": { "type": "string" },
        "message": { "type": "string" },
        "retriable": { "type": "boolean" },
        "details": { "type": "object", "additionalProperties": true }
      },
      "additionalProperties": false
    },
    "FeatureSearchInput": {
      "type": "object",
      "properties": {
        "q": { "type": "string" },
        "labels": { "type": "array", "items": { "type": "string" } },
        "options": { "type": "object", "additionalProperties": { "type": "string" } },
        "status": { "type": "string", "enum": ["draft", "active", "archived", "deprecated"] },
        "limit": { "type": "integer", "minimum": 1, "maximum": 100 }
      },
      "additionalProperties": false
    },
    "FeatureGetInput": {
      "type": "object",
      "required": ["featureId"],
      "properties": {
        "featureId": { "type": "string", "format": "uuid" }
      },
      "additionalProperties": false
    },
    "ArtifactLink": {
      "type": "object",
      "required": ["artifactType", "url"],
      "properties": {
        "artifactType": {
          "type": "string",
          "enum": ["code", "doc", "test", "runbook", "dashboard"]
        },
        "url": { "type": "string", "format": "uri" },
        "metadata": { "type": "object", "additionalProperties": true }
      },
      "additionalProperties": false
    },
    "FeatureRegisterInput": {
      "type": "object",
      "required": ["featureKey", "managementNumber", "title", "status"],
      "properties": {
        "featureKey": { "type": "string", "minLength": 1 },
        "managementNumber": { "type": "string", "minLength": 1 },
        "title": { "type": "string", "minLength": 1 },
        "background": { "type": "string" },
        "problem": { "type": "string" },
        "status": { "type": "string", "enum": ["draft", "active", "archived", "deprecated"] },
        "labels": { "type": "array", "items": { "type": "string" } },
        "options": { "type": "object", "additionalProperties": { "type": "string" } },
        "artifactLinks": { "type": "array", "items": { "$ref": "#/$defs/ArtifactLink" } }
      },
      "additionalProperties": false
    },
    "FeatureUpdateStatusInput": {
      "type": "object",
      "required": ["featureId", "status"],
      "properties": {
        "featureId": { "type": "string", "format": "uuid" },
        "status": { "type": "string", "enum": ["draft", "active", "archived", "deprecated"] },
        "reason": { "type": "string" }
      },
      "additionalProperties": false
    },
    "FeatureUseInput": {
      "type": "object",
      "required": ["featureId"],
      "properties": {
        "featureId": { "type": "string", "format": "uuid" },
        "ticketId": { "type": "string" },
        "context": { "type": "object", "additionalProperties": true }
      },
      "additionalProperties": false
    }
  }
}
