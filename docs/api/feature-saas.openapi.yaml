openapi: 3.0.3
info:
  title: ACA Feature SaaS API (Draft)
  version: 0.1.0-draft
  description: |
    Feature Registry SaaS API draft for ACA integration.
    This spec is design-only and must pass design gate before implementation.
servers:
  - url: https://feature-saas.example.com
    description: Feature SaaS (draft endpoint)

tags:
  - name: Features
    description: Feature catalog CRUD and search
  - name: Versions
    description: Feature version and rollback
  - name: Usage
    description: Feature usage and analytics
  - name: Reviews
    description: Human/Agent review records

security:
  - ApiKeyAuth: []

paths:
  /v1/features:
    post:
      tags: [Features]
      summary: Create feature
      operationId: createFeature
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeatureCreateRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeatureResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
    get:
      tags: [Features]
      summary: List features
      operationId: listFeatures
      parameters:
        - $ref: '#/components/parameters/ProjectId'
        - $ref: '#/components/parameters/Status'
        - $ref: '#/components/parameters/Labels'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
      responses:
        '200':
          description: List response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeatureListResponse'

  /v1/features/search:
    get:
      tags: [Features]
      summary: Search features
      operationId: searchFeatures
      parameters:
        - $ref: '#/components/parameters/Query'
        - $ref: '#/components/parameters/Labels'
        - $ref: '#/components/parameters/Options'
        - $ref: '#/components/parameters/ProjectId'
        - $ref: '#/components/parameters/Limit'
      responses:
        '200':
          description: Search response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeatureSearchResponse'

  /v1/features/summary:
    get:
      tags: [Features]
      summary: Get feature management summary
      operationId: getFeatureSummary
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200':
          description: Summary response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeatureSummaryResponse'

  /v1/features/{featureId}:
    get:
      tags: [Features]
      summary: Get feature by id
      operationId: getFeature
      parameters:
        - $ref: '#/components/parameters/FeatureId'
      responses:
        '200':
          description: Feature detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeatureResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      tags: [Features]
      summary: Update feature metadata
      operationId: updateFeature
      parameters:
        - $ref: '#/components/parameters/FeatureId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeaturePatchRequest'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeatureResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /v1/features/{featureId}/versions:
    get:
      tags: [Versions]
      summary: List feature versions
      operationId: listFeatureVersions
      parameters:
        - $ref: '#/components/parameters/FeatureId'
      responses:
        '200':
          description: Version list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeatureVersionListResponse'
    post:
      tags: [Versions]
      summary: Create new feature version snapshot
      operationId: createFeatureVersion
      parameters:
        - $ref: '#/components/parameters/FeatureId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeatureVersionCreateRequest'
      responses:
        '201':
          description: Version created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeatureVersionResponse'

  /v1/features/{featureId}/rollback:
    post:
      tags: [Versions]
      summary: Rollback feature to a previous version
      operationId: rollbackFeature
      parameters:
        - $ref: '#/components/parameters/FeatureId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeatureRollbackRequest'
      responses:
        '200':
          description: Rollback accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeatureRollbackResponse'
        '409':
          $ref: '#/components/responses/Conflict'

  /v1/features/{featureId}/usage-events:
    post:
      tags: [Usage]
      summary: Record feature usage event
      operationId: createFeatureUsageEvent
      parameters:
        - $ref: '#/components/parameters/FeatureId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeatureUsageEventRequest'
      responses:
        '202':
          description: Usage event accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcceptedResponse'

  /v1/features/{featureId}/reviews:
    post:
      tags: [Reviews]
      summary: Add review decision
      operationId: createFeatureReview
      parameters:
        - $ref: '#/components/parameters/FeatureId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeatureReviewRequest'
      responses:
        '201':
          description: Review added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeatureReviewResponse'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key

  parameters:
    FeatureId:
      name: featureId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    ProjectId:
      name: projectId
      in: query
      required: false
      schema:
        type: string
        format: uuid
    Status:
      name: status
      in: query
      required: false
      schema:
        type: string
        enum: [draft, active, archived, deprecated]
    Labels:
      name: labels
      in: query
      required: false
      schema:
        type: array
        items:
          type: string
      style: form
      explode: false
    Options:
      name: options
      in: query
      required: false
      schema:
        type: array
        items:
          type: string
      style: form
      explode: false
    Query:
      name: q
      in: query
      required: false
      schema:
        type: string
    Limit:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
    Cursor:
      name: cursor
      in: query
      required: false
      schema:
        type: string

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    FeatureCreateRequest:
      type: object
      required: [organizationId, projectId, featureKey, managementNumber, title, status]
      properties:
        organizationId: { type: string, format: uuid }
        projectId: { type: string, format: uuid }
        featureKey: { type: string, minLength: 1 }
        managementNumber: { type: string, minLength: 1 }
        title: { type: string, minLength: 1 }
        background: { type: string }
        problem: { type: string }
        status:
          type: string
          enum: [draft, active, archived, deprecated]
        labels:
          type: array
          items: { type: string }
        options:
          type: object
          additionalProperties: { type: string }
        artifactLinks:
          type: array
          items:
            $ref: '#/components/schemas/ArtifactLink'

    FeaturePatchRequest:
      type: object
      minProperties: 1
      properties:
        title: { type: string }
        background: { type: string }
        problem: { type: string }
        status:
          type: string
          enum: [draft, active, archived, deprecated]
        labels:
          type: array
          items: { type: string }
        options:
          type: object
          additionalProperties: { type: string }

    FeatureResponse:
      type: object
      required: [featureId, organizationId, projectId, featureKey, managementNumber, title, status, latestVersion, usageCount, createdAt, updatedAt]
      properties:
        featureId: { type: string, format: uuid }
        organizationId: { type: string, format: uuid }
        projectId: { type: string, format: uuid }
        featureKey: { type: string }
        managementNumber: { type: string }
        title: { type: string }
        background: { type: string }
        problem: { type: string }
        status:
          type: string
          enum: [draft, active, archived, deprecated]
        latestVersion: { type: integer, minimum: 1 }
        usageCount: { type: integer, minimum: 0 }
        lastUsedAt: { type: string, format: date-time, nullable: true }
        labels:
          type: array
          items: { type: string }
        options:
          type: object
          additionalProperties: { type: string }
        artifactLinks:
          type: array
          items:
            $ref: '#/components/schemas/ArtifactLink'
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    FeatureListResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/FeatureResponse'
        nextCursor:
          type: string
          nullable: true

    FeatureSearchResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/FeatureResponse'
              - type: object
                properties:
                  score:
                    type: number
                    minimum: 0
                    maximum: 1

    FeatureSummaryResponse:
      type: object
      required: [total, byStatus]
      properties:
        total: { type: integer, minimum: 0 }
        byStatus:
          type: object
          additionalProperties:
            type: integer
            minimum: 0
        recentlyUpdated:
          type: array
          items:
            $ref: '#/components/schemas/FeatureResponse'

    FeatureVersionCreateRequest:
      type: object
      required: [changeSummary, payload, checksum]
      properties:
        changeSummary: { type: string }
        payload: { type: object, additionalProperties: true }
        checksum: { type: string, minLength: 1 }

    FeatureVersionResponse:
      type: object
      required: [versionId, featureId, versionNo, checksum, createdAt]
      properties:
        versionId: { type: string, format: uuid }
        featureId: { type: string, format: uuid }
        versionNo: { type: integer, minimum: 1 }
        changeSummary: { type: string }
        checksum: { type: string }
        createdBy: { type: string }
        createdAt: { type: string, format: date-time }

    FeatureVersionListResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/FeatureVersionResponse'

    FeatureRollbackRequest:
      type: object
      required: [targetVersionNo, reason]
      properties:
        targetVersionNo: { type: integer, minimum: 1 }
        reason: { type: string, minLength: 1 }

    FeatureRollbackResponse:
      type: object
      required: [featureId, targetVersionNo, newVersionNo, status]
      properties:
        featureId: { type: string, format: uuid }
        targetVersionNo: { type: integer, minimum: 1 }
        newVersionNo: { type: integer, minimum: 1 }
        status: { type: string, enum: [accepted, rejected] }

    FeatureUsageEventRequest:
      type: object
      required: [ticketId, actor]
      properties:
        ticketId: { type: string, minLength: 1 }
        actor: { type: string, minLength: 1 }
        context: { type: object, additionalProperties: true }

    FeatureReviewRequest:
      type: object
      required: [reviewer, decision]
      properties:
        reviewer: { type: string, minLength: 1 }
        decision:
          type: string
          enum: [approved, changes_requested]
        comment: { type: string }

    FeatureReviewResponse:
      type: object
      required: [reviewId, featureId, reviewer, decision, reviewedAt]
      properties:
        reviewId: { type: string, format: uuid }
        featureId: { type: string, format: uuid }
        reviewer: { type: string }
        decision: { type: string, enum: [approved, changes_requested] }
        comment: { type: string }
        reviewedAt: { type: string, format: date-time }

    ArtifactLink:
      type: object
      required: [artifactType, url]
      properties:
        artifactType:
          type: string
          enum: [code, doc, test, runbook, dashboard]
        url:
          type: string
          format: uri
        metadata:
          type: object
          additionalProperties: true

    AcceptedResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [accepted]

    ErrorResponse:
      type: object
      required: [code, message]
      properties:
        code: { type: string }
        message: { type: string }
        details:
          type: object
          additionalProperties: true
